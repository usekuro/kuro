<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>UseKuro Dashboard - Protocol Mock Server</title>
    <meta
            name="viewport"
            content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <meta name="theme-color" content="#0b0f14"/>
    <!-- Tailwind (CDN for development only) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue 3 production -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <!-- Lucide icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        :root {
            --brand: #00d4ff;
            --text: #ffffff;
            --muted: #94a3b8;
            --bg: #0b0f14;
            --surface: #1a202c;
        }

        body {
            background: linear-gradient(135deg, #0b0f14 0%, #1a202c 100%);
            color: var(--text);
            font-family: "Inter", system-ui, sans-serif;
            min-height: 100vh;
        }

        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .card {
            background: linear-gradient(
                    135deg,
                    rgba(255, 255, 255, 0.1) 0%,
                    rgba(255, 255, 255, 0.05) 100%
            );
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 20px;
            transition: all 0.3s ease;
            position: relative;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            border-color: rgba(0, 212, 255, 0.3);
        }

        .protocol-http {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
        }

        .protocol-sftp {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
        }

        .protocol-tcp {
            background: rgba(168, 85, 247, 0.2);
            color: #a78bfa;
        }

        .protocol-websocket {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .status-online {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
        }

        .status-offline {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(0, 212, 255, 0.5);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: rgba(0, 212, 255, 0.2);
            border-color: rgba(0, 212, 255, 0.5);
            color: #00d4ff;
        }

        .btn-success {
            background: rgba(34, 197, 94, 0.2);
            border-color: rgba(34, 197, 94, 0.5);
            color: #4ade80;
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.5);
            color: #f87171;
        }

        .btn-warning {
            background: rgba(251, 191, 36, 0.2);
            border-color: rgba(251, 191, 36, 0.5);
            color: #fbbf24;
        }

        .btn-secondary {
            background: rgba(148, 163, 184, 0.2);
            border-color: rgba(148, 163, 184, 0.5);
            color: #e2e8f0;
        }

        .btn-info {
            background: rgba(59, 130, 246, 0.2);
            border-color: rgba(59, 130, 246, 0.5);
            color: #60a5fa;
        }

        .btn-sm {
            padding: 6px 10px;
            font-size: 12px;
            border-radius: 6px;
        }

        .config-editor {
            font-family: "Monaco", "Menlo", "Ubuntu Mono", monospace;
            background: #1a1a1a;
            color: #f8f8f2;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 16px;
            resize: vertical;
            min-height: 300px;
            font-size: 14px;
            line-height: 1.5;
        }

        .tab-button {
            padding: 12px 24px;
            border: none;
            background: transparent;
            color: var(--muted);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .tab-button.active {
            color: var(--brand);
            border-bottom-color: var(--brand);
        }

        .tab-button:hover {
            color: var(--text);
        }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            padding: 20px;
        }

        .modal-content {
            background: var(--surface);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 90vw;
            max-height: 90vh;
            overflow: auto;
            backdrop-filter: blur(20px);
        }

        .error-toast,
        .success-toast,
        .warning-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            color: #fff;
            padding: 16px;
            border-radius: 8px;
            z-index: 1000;
            max-width: 400px;
            backdrop-filter: blur(10px);
            animation: slideIn 0.3s ease;
        }

        .error-toast {
            background: rgba(239, 68, 68, 0.9);
            border: 1px solid rgba(239, 68, 68, 0.5);
        }

        .success-toast {
            background: rgba(34, 197, 94, 0.9);
            border: 1px solid rgba(34, 197, 94, 0.5);
        }

        .warning-toast {
            background: rgba(251, 191, 36, 0.9);
            border: 1px solid rgba(251, 191, 36, 0.5);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
            position: relative;
        }

        .loading::after {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid #fff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .server-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
        }

        .server-status.online {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            color: #4ade80;
        }

        .server-status.offline {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #f87171;
        }

        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {
            0%,
            100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        .text-muted {
            color: var(--muted);
        }

        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
</head>
<body>
<div id="app" class="min-h-screen">
    <!-- Header -->
    <header class="glass p-6 mb-6 sticky top-0 z-10">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-4">
                <h1 class="text-3xl font-bold">UseKuro Dashboard</h1>
                <span class="text-lg text-muted"
                >Protocol Mock Server</span
                >
            </div>
            <div class="flex items-center gap-4">
                <div
                        :class="serverRunning ? 'online' : 'offline'"
                        class="server-status">
                    <div
                            :class="serverRunning ? 'bg-green-400 pulse' : 'bg-red-400'"
                            class="w-3 h-3 rounded-full"
                    ></div>
                    {{ serverRunning ? 'Server Online' : 'Server Offline' }}
                    <span class="text-sm opacity-75"
                    >({{ runningMocks }}/{{ mocks.length }}
                                running)</span>
                </div>
                <button
                        @click="toggleServer"
                        :disabled="isLoading"
                        :class="serverRunning ? 'btn-danger' : 'btn-success'"
                        class="btn"
                >
                    {{ serverRunning ? 'Stop Server' : 'Start Server' }}
                </button>
                <button
                        @click="refresh"
                        :disabled="isLoading"
                        class="btn"
                >
                    Refresh
                </button>
            </div>
        </div>
    </header>

    <div class="px-6 pb-6">
        <!-- Tabs -->
        <div class="flex border-b border-white/10 mb-6">
            <button
                    @click="activeTab = 'mocks'"
                    :class="{ active: activeTab === 'mocks' }"
                    class="tab-button"
            >
                Mock Services
            </button>
            <button
                    @click="activeTab = 'workspace'"
                    :class="{ active: activeTab === 'workspace' }"
                    class="tab-button"
            >
                User Workspace
            </button>
            <button
                    @click="activeTab = 'public-config'"
                    :class="{ active: activeTab === 'public-config' }"
                    class="tab-button"
            >
                Public Config
            </button>
            <button
                    @click="activeTab = 'config'"
                    :class="{ active: activeTab === 'config' }"
                    class="tab-button"
            >
                Configuration Editor
            </button>
            <button
                    @click="activeTab = 'monitor'"
                    :class="{ active: activeTab === 'monitor' }"
                    class="tab-button"
            >
                Monitor
            </button>
        </div>

        <!-- Mocks Tab -->
        <div v-if="activeTab === 'mocks'">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-semibold">Mock Services</h2>
                <div class="flex gap-3">
                    <button
                            @click="createNewMock"
                            class="btn btn-primary"
                    >
                        + Create Mock
                    </button>
                    <label
                            class="btn"
                            style="
                                    background: rgba(59, 130, 246, 0.2);
                                    border-color: rgba(59, 130, 246, 0.5);
                                    color: #60a5fa;
                                "
                    >
                        Import .kuro
                        <input
                                type="file"
                                accept=".kuro,.yaml,.yml"
                                class="hidden"
                                @change="importKuroFile"
                        />
                    </label>
                    <button
                            @click="saveServerState"
                            class="btn btn-warning"
                    >
                        Save State
                    </button>
                    <button
                            @click="restoreServerState"
                            class="btn btn-warning"
                    >
                        Restore State
                    </button>
                </div>
            </div>

            <div
                    class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"
            >
                <div
                        v-for="(mock, index) in sortedMocks"
                        :key="mock.id"
                        class="card"
                        :style="{ order: index }"
                >
                    <div class="flex items-center justify-between mb-4">
                        <div
                                :class="getProtocolClass(mock.Protocol)"
                                class="px-3 py-1 rounded-full text-sm font-medium"
                        >
                            {{ mock.Protocol.toUpperCase() }}
                        </div>
                        <div
                                :class="mock.Running ? 'status-online' : 'status-offline'"
                                class="px-3 py-1 rounded-full text-sm flex items-center gap-2"
                        >
                            <div
                                    :class="mock.Running ? 'bg-green-400 pulse' : 'bg-red-400'"
                                    class="w-2 h-2 rounded-full"
                            ></div>
                            {{ mock.Running ? 'ONLINE' : 'OFFLINE' }}
                        </div>
                    </div>

                    <h3 class="text-lg font-semibold mb-2">
                        {{ mock.Name }}
                    </h3>
                    <p class="text-muted text-sm mb-3 line-clamp-2">
                        {{ mock.Description || 'No description' }}
                    </p>

                    <div class="space-y-2 mb-4">
                        <div class="flex justify-between">
                                    <span class="text-muted">Port:</span
                                    ><span class="font-mono"
                        >{{ mock.Port }}</span
                        >
                        </div>
                        <div
                                class="flex justify-between"
                                v-if="mock.LastStarted"
                        >
                                    <span class="text-muted"
                                    >Last Started:</span
                                    >
                            <span class="text-sm"
                            >{{ formatTime(mock.LastStarted)
                                        }}</span
                            >
                        </div>
                    </div>

                    <div class="flex gap-2">
                        <button
                                @click="toggleMock(mock.id)"
                                :disabled="!serverRunning || isLoading"
                                :class="mock.Running ? 'btn-danger' : 'btn-success'"
                                class="btn flex-1"
                        >
                            {{ mock.Running ? 'Stop' : 'Start' }}
                        </button>
                        <button @click="editMock(mock)" class="btn">
                            Edit
                        </button>
                        <button
                                @click="editMockConfig(mock)"
                                class="btn btn-primary"
                        >
                            Config
                        </button>
                    </div>
                </div>
            </div>

            <div v-if="mocks.length === 0" class="text-center py-12">
                <p class="text-muted text-lg">No mocks available</p>
                <p class="text-muted">
                    Create a new mock or import a .kuro file to get
                    started
                </p>
            </div>
        </div>

        <!-- Public Configuration Tab -->
        <div v-if="activeTab === 'public-config'">
            <div class="glass rounded-2xl p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-semibold">
                        🔧 Public Configuration
                    </h2>
                    <button
                            @click="refreshPublicConfig"
                            class="btn btn-primary"
                    >
                        🔄 Refresh
                    </button>
                </div>

                <div v-if="publicConfig" class="space-y-6">
                    <!-- SFTP Connection Info -->
                    <div class="glass rounded-xl p-4">
                        <h3
                                class="text-lg font-medium mb-4 flex items-center"
                        >
                            📁 SFTP Connection Details
                        </h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label
                                        class="block text-sm font-medium mb-1"
                                >Host</label
                                >
                                <input
                                        readonly
                                        :value="publicConfig.sftp.host"
                                        class="w-full p-2 rounded bg-black bg-opacity-30 border border-white border-opacity-20"
                                />
                            </div>
                            <div>
                                <label
                                        class="block text-sm font-medium mb-1"
                                >Port</label
                                >
                                <input
                                        readonly
                                        :value="publicConfig.sftp.port"
                                        class="w-full p-2 rounded bg-black bg-opacity-30 border border-white border-opacity-20"
                                />
                            </div>
                            <div>
                                <label
                                        class="block text-sm font-medium mb-1"
                                >Username</label
                                >
                                <input
                                        readonly
                                        :value="publicConfig.sftp.username"
                                        class="w-full p-2 rounded bg-black bg-opacity-30 border border-white border-opacity-20"
                                />
                            </div>
                            <div>
                                <label
                                        class="block text-sm font-medium mb-1"
                                >Password</label
                                >
                                <input
                                        readonly
                                        :value="publicConfig.sftp.password"
                                        class="w-full p-2 rounded bg-black bg-opacity-30 border border-white border-opacity-20"
                                />
                            </div>
                        </div>
                        <div class="mt-4">
                            <label
                                    class="block text-sm font-medium mb-1"
                            >Quick Connect Command</label
                            >
                            <div
                                    class="bg-black bg-opacity-50 p-3 rounded font-mono text-sm"
                            >
                                sftp -P {{ publicConfig.sftp.port }} {{
                                publicConfig.sftp.username }}@{{
                                publicConfig.sftp.host }}
                            </div>
                        </div>
                    </div>

                    <!-- SSH Key Info -->
                    <div class="glass rounded-xl p-4">
                        <h3
                                class="text-lg font-medium mb-4 flex items-center"
                        >
                            🔑 SSH Host Key Information
                        </h3>
                        <div>
                            <label
                                    class="block text-sm font-medium mb-1"
                            >Fingerprint</label
                            >
                            <div
                                    class="bg-black bg-opacity-50 p-3 rounded font-mono text-sm break-all"
                            >
                                {{ publicConfig.ssh.fingerprint }}
                            </div>
                        </div>
                    </div>

                    <!-- Workspace Info -->
                    <div class="glass rounded-xl p-4">
                        <h3
                                class="text-lg font-medium mb-4 flex items-center"
                        >
                            💾 Workspace Information
                        </h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label
                                        class="block text-sm font-medium mb-1"
                                >Default Path</label
                                >
                                <input
                                        readonly
                                        :value="publicConfig.workspace.default_path"
                                        class="w-full p-2 rounded bg-black bg-opacity-30 border border-white border-opacity-20"
                                />
                            </div>
                            <div>
                                <label
                                        class="block text-sm font-medium mb-1"
                                >User Config Directory</label
                                >
                                <input
                                        readonly
                                        :value="publicConfig.workspace.user_config_dir"
                                        class="w-full p-2 rounded bg-black bg-opacity-30 border border-white border-opacity-20"
                                />
                            </div>
                        </div>
                    </div>

                    <!-- Server Info -->
                    <div class="glass rounded-xl p-4">
                        <h3
                                class="text-lg font-medium mb-4 flex items-center"
                        >
                            🖥️ Server Information
                        </h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label
                                        class="block text-sm font-medium mb-1"
                                >Server Name</label
                                >
                                <input
                                        readonly
                                        :value="publicConfig.info.server_name"
                                        class="w-full p-2 rounded bg-black bg-opacity-30 border border-white border-opacity-20"
                                />
                            </div>
                            <div>
                                <label
                                        class="block text-sm font-medium mb-1"
                                >Version</label
                                >
                                <input
                                        readonly
                                        :value="publicConfig.info.version"
                                        class="w-full p-2 rounded bg-black bg-opacity-30 border border-white border-opacity-20"
                                />
                            </div>
                        </div>
                        <div class="mt-4">
                            <label
                                    class="block text-sm font-medium mb-1"
                            >Generated At</label
                            >
                            <input
                                    readonly
                                    :value="publicConfig.info.generated_at"
                                    class="w-full p-2 rounded bg-black bg-opacity-30 border border-white border-opacity-20"
                            />
                        </div>
                    </div>
                </div>

                <div v-else class="text-center py-12">
                    <p class="text-muted text-lg">
                        Loading configuration...
                    </p>
                </div>
            </div>
        </div>

        <!-- User Workspace Tab -->
        <div v-if="activeTab === 'workspace'">
            <div class="glass rounded-2xl p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-semibold">
                        👤 User Workspace
                    </h2>
                    <div class="flex gap-3">
                        <button
                                @click="refreshUserMocks"
                                class="btn btn-primary"
                        >
                            🔄 Refresh
                        </button>
                        <button
                                @click="createUserMock"
                                class="btn btn-success"
                        >
                            ➕ New Mock
                        </button>
                        <button
                                @click="importUserMock"
                                class="btn btn-info"
                        >
                            📥 Import
                        </button>
                        <button
                                @click="openWorkspaceManager"
                                class="btn btn-secondary"
                        >
                            🏢 Workspaces
                        </button>
                    </div>
                </div>

                <!-- Workspace Info & Stats -->
                <div class="mb-6">
                    <!-- Workspace Header -->
                    <div class="glass rounded-xl p-4 mb-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-lg font-medium">
                                    {{ currentUser === 'default' ?
                                    'Default Workspace' : currentUser }}
                                </h3>
                                <p class="text-sm text-muted">
                                    {{ currentUser === 'default' ? 'Read-only examples and your first mocks' : 'Your personal workspace for custom mocks' }}
                                </p>
                            </div>
                            <div class="flex items-center gap-2">
                                        <span
                                                v-if="currentUser === 'default'"
                                                class="px-2 py-1 bg-blue-500/20 text-blue-400 text-xs rounded"
                                        >
                                            Protected
                                        </span>
                                <span
                                        v-else
                                        class="px-2 py-1 bg-green-500/20 text-green-400 text-xs rounded"
                                >
                                            User Workspace
                                        </span>
                            </div>
                        </div>
                    </div>

                    <!-- User Stats -->
                    <div
                            v-if="userStats"
                            class="grid grid-cols-4 gap-4"
                    >
                        <div class="glass rounded-xl p-4 text-center">
                            <div class="text-2xl font-bold">
                                {{ userStats.total_mocks }}
                            </div>
                            <div class="text-sm text-muted">
                                Total Mocks
                            </div>
                        </div>
                        <div class="glass rounded-xl p-4 text-center">
                            <div class="text-2xl font-bold">
                                {{ userStats.created_today }}
                            </div>
                            <div class="text-sm text-muted">
                                Created Today
                            </div>
                        </div>
                        <div class="glass rounded-xl p-4 text-center">
                            <div class="text-2xl font-bold">
                                {{ Object.keys(userStats.by_protocol ||
                                {}).length }}
                            </div>
                            <div class="text-sm text-muted">
                                Protocols
                            </div>
                        </div>
                        <div class="glass rounded-xl p-4 text-center">
                            <div class="text-2xl font-bold">
                                {{ Object.keys(userStats.by_source ||
                                {}).length }}
                            </div>
                            <div class="text-sm text-muted">
                                Sources
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Example Mocks (Read-only) -->
                <div v-if="exampleMocks.length > 0" class="mb-8">
                    <h4
                            class="text-lg font-medium mb-4 flex items-center gap-2"
                    >
                        📚 Example Mocks
                        <span class="text-sm text-muted"
                        >(Read-only templates)</span
                        >
                    </h4>
                    <div class="space-y-3">
                        <div
                                v-for="mock in exampleMocks"
                                :key="mock.id"
                                class="glass rounded-xl p-4 border border-blue-500/20"
                        >
                            <div
                                    class="flex items-center justify-between"
                            >
                                <div class="flex-1">
                                    <div
                                            class="flex items-center gap-3"
                                    >
                                                <span
                                                        class="protocol-badge"
                                                        :data-protocol="mock.protocol"
                                                >{{
                                                    mock.protocol.toUpperCase()
                                                    }}</span
                                                >
                                        <h3 class="text-lg font-medium">
                                            {{ mock.name }}
                                        </h3>
                                        <span class="text-sm text-muted"
                                        >:{{ mock.port }}</span
                                        >
                                        <span
                                                class="px-2 py-1 bg-blue-500/20 text-blue-400 text-xs rounded"
                                        >
                                                    Example
                                                </span>
                                    </div>
                                    <p class="text-sm text-muted mt-1">
                                        {{ mock.description }}
                                    </p>
                                </div>
                                <div class="flex items-center gap-2">
                                    <button
                                            @click="exportUserMock(mock)"
                                            class="btn btn-sm btn-secondary"
                                            title="Export as template"
                                    >
                                        📤
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- User Mocks -->
                <div>
                    <h4
                            class="text-lg font-medium mb-4 flex items-center gap-2"
                    >
                        👤 Your Mocks
                        <span class="text-sm text-muted"
                        >({{ userMocks.length }} total)</span
                        >
                    </h4>
                    <div class="space-y-4">
                        <div
                                v-for="mock in userMocks"
                                :key="mock.id"
                                class="glass rounded-xl p-4"
                        >
                            <div
                                    class="flex items-center justify-between"
                            >
                                <div class="flex-1">
                                    <div
                                            class="flex items-center gap-3"
                                    >
                                                <span
                                                        class="protocol-badge"
                                                        :data-protocol="mock.protocol"
                                                >{{
                                                    mock.protocol.toUpperCase()
                                                    }}</span
                                                >
                                        <h3 class="text-lg font-medium">
                                            {{ mock.name }}
                                        </h3>
                                        <span class="text-sm text-muted"
                                        >:{{ mock.port }}</span
                                        >
                                        <span
                                                class="px-2 py-1 bg-green-500/20 text-green-400 text-xs rounded"
                                        >
                                                    User
                                                </span>
                                    </div>
                                    <p class="text-sm text-muted mt-1">
                                        {{ mock.description }}
                                    </p>
                                    <div
                                            class="flex items-center gap-4 mt-2 text-xs text-muted"
                                    >
                                                <span
                                                >Source: {{ mock.source
                                                    }}</span
                                                >
                                        <span
                                        >Created: {{
                                                    formatDate(mock.created_at)
                                                    }}</span
                                        >
                                        <span
                                        >Updated: {{
                                                    formatDate(mock.updated_at)
                                                    }}</span
                                        >
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <button
                                            @click="editUserMock(mock)"
                                            class="btn btn-sm btn-info"
                                            title="Edit mock"
                                    >
                                        ✏️
                                    </button>
                                    <button
                                            @click="exportUserMock(mock)"
                                            class="btn btn-sm btn-secondary"
                                            title="Export mock"
                                    >
                                        📤
                                    </button>
                                    <button
                                            @click="deleteUserMock(mock)"
                                            class="btn btn-sm btn-danger"
                                            title="Delete mock"
                                    >
                                        🗑️
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div
                            v-if="userMocks.length === 0"
                            class="text-center py-12"
                    >
                        <p class="text-muted text-lg">
                            No user mocks found
                        </p>
                        <p class="text-muted">
                            Create your first mock to get started with
                            persistent configurations
                        </p>
                        <p class="text-sm text-muted mt-2">
                            💡 Tip: Use example mocks above as templates
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Configuration Editor Tab -->
        <div v-if="activeTab === 'config'">
            <div class="glass rounded-2xl p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-semibold">
                        Configuration Editor
                    </h2>
                    <div class="flex gap-3" v-if="selectedConfigMock">
                        <button
                                @click="saveConfig"
                                class="btn btn-success"
                        >
                            Save Configuration
                        </button>
                        <button
                                @click="resetConfig"
                                class="btn btn-danger"
                        >
                            Reset Changes
                        </button>
                        <button
                                @click="addEndpoint"
                                class="btn btn-primary"
                        >
                            + Add Endpoint
                        </button>
                    </div>
                </div>

                <div
                        v-if="!selectedConfigMock"
                        class="text-center py-12"
                >
                    <p class="text-muted text-lg">
                        Select a mock to edit its configuration
                    </p>
                    <p class="text-muted">
                        Go to Mock Services tab and click "Config" on
                        any mock
                    </p>
                </div>

                <div v-else>
                    <div class="mb-4">
                        <h3 class="text-lg font-semibold mb-2">
                            Editing: {{ selectedConfigMock.Name }}
                        </h3>
                        <p class="text-muted">
                            Protocol: {{ selectedConfigMock.Protocol }}
                            | Port: {{ selectedConfigMock.Port }}
                        </p>
                    </div>

                    <textarea
                            v-model="configContent"
                            class="config-editor w-full"
                            placeholder="# Edit your .kuro configuration here..."
                    ></textarea>

                    <div class="mt-4 p-4 bg-black/20 rounded-lg">
                        <h4 class="font-semibold mb-2">
                            Quick Actions:
                        </h4>
                        <div class="flex gap-2 flex-wrap">
                            <button
                                    @click="addEndpoint"
                                    class="btn btn-primary"
                            >
                                Add HTTP Endpoint
                            </button>
                            <button @click="addVariable" class="btn">
                                Add Variable
                            </button>
                            <button @click="addResponse" class="btn">
                                Add Response Template
                            </button>
                            <button
                                    @click="validateConfig"
                                    class="btn btn-warning"
                            >
                                Validate
                            </button>
                        </div>
                    </div>

                    <div
                            v-if="configValidation"
                            class="mt-4 p-4 rounded-lg"
                            :class="configValidation.valid ? 'bg-green-900/20 border border-green-500/30' : 'bg-red-900/20 border border-red-500/30'">
                        <h4 class="font-semibold mb-2">
                            {{ configValidation.valid ? '✅ Configuration Valid' : '❌ Configuration Errors' }}
                        </h4>
                        <pre
                                v-if="!configValidation.valid"
                                class="text-sm text-red-400"
                        >
{{ configValidation.errors }}</pre
                        >
                        <p v-else class="text-sm text-green-400">
                            Configuration is valid and ready to use.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Monitor Tab -->
        <div v-if="activeTab === 'monitor'">
            <div class="glass rounded-2xl p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-semibold">
                        Real-time Monitor
                    </h2>
                    <div class="flex gap-3">
                        <button
                                @click="clearLogs"
                                class="btn btn-danger"
                        >
                            Clear Logs
                        </button>
                        <button @click="exportLogs" class="btn">
                            Export Logs
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="card">
                        <h3 class="text-sm text-muted mb-2">
                            Total Mocks
                        </h3>
                        <p class="text-2xl font-bold">
                            {{ mocks.length }}
                        </p>
                    </div>
                    <div class="card">
                        <h3 class="text-sm text-muted mb-2">Running</h3>
                        <p class="text-2xl font-bold text-green-400">
                            {{ runningMocks }}
                        </p>
                    </div>
                    <div class="card">
                        <h3 class="text-sm text-muted mb-2">Stopped</h3>
                        <p class="text-2xl font-bold text-red-400">
                            {{ mocks.length - runningMocks }}
                        </p>
                    </div>
                    <div class="card">
                        <h3 class="text-sm text-muted mb-2">
                            Server Uptime
                        </h3>
                        <p class="text-2xl font-bold">
                            {{ serverUptime }}
                        </p>
                    </div>
                </div>

                <div class="space-y-2 max-h-96 overflow-y-auto">
                    <div
                            v-for="(log, index) in requestLogs"
                            :key="index"
                            class="flex items-center gap-3 text-sm p-3 rounded-lg bg-black/20"
                    >
                                <span class="text-muted w-20"
                                >{{ log.time }}</span
                                >
                        <span
                                :class="getLogTypeClass(log.type)"
                                class="px-2 py-1 rounded text-xs font-medium w-16 text-center"
                        >{{ log.type }}</span
                        >
                        <span class="font-mono text-sm"
                        >{{ log.method }}</span
                        >
                        <span class="flex-1">{{ log.message }}</span>
                        <span
                                v-if="log.status"
                                :class="getStatusClass(log.status)"
                                class="px-2 py-1 rounded text-xs font-medium"
                        >{{ log.status }}</span
                        >
                    </div>
                    <div
                            v-if="requestLogs.length === 0"
                            class="text-center py-8"
                    >
                        <p class="text-muted">No activity logs yet</p>
                        <p class="text-muted text-sm">
                            Start some mocks to see request logs here
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toasts -->
    <div
            v-for="toast in toasts"
            :key="toast.id"
            :class="toast.type + '-toast'"
    >
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
                <i :data-lucide="toast.icon" class="w-5 h-5"></i>
                <div>
                    <div class="font-semibold">{{ toast.title }}</div>
                    <div class="text-sm opacity-90">
                        {{ toast.message }}
                    </div>
                </div>
            </div>
            <button
                    @click="removeToast(toast.id)"
                    class="ml-4 opacity-75 hover:opacity-100"
            >
                <i data-lucide="x" class="w-4 h-4"></i>
            </button>
        </div>
    </div>

    <!-- Edit Modal -->
    <div v-if="showEditModal" class="modal" @click="closeEditModal">
        <div class="modal-content p-6 w-full max-w-md" @click.stop>
            <h3 class="text-xl font-semibold mb-4">
                {{ editingMock.id ? 'Edit Mock' : 'Create Mock' }}
            </h3>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2"
                    >Name</label
                    >
                    <input
                            v-model="editingMock.Name"
                            class="w-full p-3 rounded-lg bg-black bg-opacity-30 border border-white border-opacity-20"
                            placeholder="Mock service name"
                    />
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2"
                    >Protocol</label
                    >
                    <select
                            v-model="editingMock.Protocol"
                            class="w-full p-3 rounded-lg bg-black bg-opacity-30 border border-white border-opacity-20"
                    >
                        <option value="http">HTTP</option>
                        <option value="https">HTTPS</option>
                        <option value="sftp">SFTP</option>
                        <option value="tcp">TCP</option>
                        <option value="websocket">WebSocket</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2"
                    >Port</label
                    >
                    <input
                            v-model.number="editingMock.Port"
                            type="number"
                            min="1"
                            max="65535"
                            class="w-full p-3 rounded-lg bg-black bg-opacity-30 border border-white border-opacity-20"
                            placeholder="8080"
                            @input="validatePort"
                    />
                    <div
                            v-if="portValidation.error"
                            class="mt-2 text-red-400 text-sm"
                    >
                        {{ portValidation.message }}
                    </div>
                    <div
                            v-if="portValidation.conflicts.length > 0"
                            class="mt-2 text-amber-400 text-sm"
                    >
                        ⚠️ Port conflicts with: {{
                        portValidation.conflicts.join(', ') }}
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2"
                    >Description</label
                    >
                    <textarea
                            v-model="editingMock.Description"
                            rows="3"
                            class="w-full p-3 rounded-lg bg-black bg-opacity-30 border border-white border-opacity-20"
                            placeholder="Brief description of this mock service..."
                    ></textarea>
                </div>
            </div>

            <div class="flex gap-3 mt-6">
                <button
                        @click="saveMock"
                        :disabled="portValidation.error || isLoading"
                        :class="isLoading ? 'loading' : ''"
                        class="btn btn-primary flex-1"
                >
                    {{ isLoading ? 'Saving...' : (editingMock.id ?
                    'Update' : 'Create') }}
                </button>
                <button
                        @click="closeEditModal"
                        :disabled="isLoading"
                        class="btn"
                >
                    Cancel
                </button>
            </div>
        </div>

        <!-- User Mock Edit Modal -->
        <div
                v-if="showUserMockModal"
                class="modal"
                @click="showUserMockModal = false"
        >
            <div class="modal-content p-6 w-full max-w-4xl" @click.stop>
                <h3 class="text-xl font-semibold mb-4">
                    {{ editingUserMock.id ? 'Edit User Mock' : 'Create User Mock' }}
                </h3>

                <div class="grid grid-cols-2 gap-6">
                    <!-- Left side: Basic info -->
                    <div class="space-y-4">
                        <div>
                            <label
                                    class="block text-sm font-medium mb-2"
                            >Name</label
                            >
                            <input
                                    v-model="editingUserMock.name"
                                    class="w-full p-3 rounded-lg bg-black bg-opacity-30 border border-white border-opacity-20"
                                    placeholder="Mock service name"
                            />
                        </div>

                        <div>
                            <label
                                    class="block text-sm font-medium mb-2"
                            >Protocol</label
                            >
                            <select
                                    v-model="editingUserMock.protocol"
                                    class="w-full p-3 rounded-lg bg-black bg-opacity-30 border border-white border-opacity-20"
                            >
                                <option value="http">HTTP</option>
                                <option value="https">HTTPS</option>
                                <option value="sftp">SFTP</option>
                                <option value="tcp">TCP</option>
                                <option value="websocket">
                                    WebSocket
                                </option>
                            </select>
                        </div>

                        <div>
                            <label
                                    class="block text-sm font-medium mb-2"
                            >Port</label
                            >
                            <input
                                    v-model.number="editingUserMock.port"
                                    type="number"
                                    min="1"
                                    max="65535"
                                    class="w-full p-3 rounded-lg bg-black bg-opacity-30 border border-white border-opacity-20"
                                    placeholder="8080"
                            />
                        </div>

                        <div>
                            <label
                                    class="block text-sm font-medium mb-2"
                            >Description</label
                            >
                            <textarea
                                    v-model="editingUserMock.description"
                                    class="w-full p-3 rounded-lg bg-black bg-opacity-30 border border-white border-opacity-20"
                                    rows="3"
                                    placeholder="Describe your mock service"
                            ></textarea>
                        </div>
                    </div>

                    <!-- Right side: Configuration content -->
                    <div>
                        <label class="block text-sm font-medium mb-2"
                        >Configuration Content (.kuro)</label
                        >
                        <textarea
                                v-model="editingUserMock.content"
                                class="w-full h-96 p-3 rounded-lg bg-black bg-opacity-30 border border-white border-opacity-20 font-mono text-sm"
                                placeholder="Enter your .kuro file content here..."
                        ></textarea>
                    </div>
                </div>

                <div class="flex gap-3 mt-6">
                    <button
                            @click="saveUserMock"
                            :disabled="isLoading"
                            :class="isLoading ? 'loading' : ''"
                            class="btn btn-primary flex-1"
                    >
                        {{ isLoading ? 'Saving...' : (editingUserMock.id
                        ? 'Update' : 'Create') }}
                    </button>
                    <button
                            @click="showUserMockModal = false"
                            :disabled="isLoading"
                            class="btn"
                    >
                        Cancel
                    </button>
                </div>
            </div>
        </div>

        <!-- Import Mock Modal -->
        <div
                v-if="showImportModal"
                class="modal"
                @click="showImportModal = false"
        >
            <div class="modal-content p-6 w-full max-w-2xl" @click.stop>
                <h3 class="text-xl font-semibold mb-4">
                    Import Mock Configuration
                </h3>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2"
                        >Paste .kuro file content</label
                        >
                        <textarea
                                v-model="importContent"
                                class="w-full h-64 p-3 rounded-lg bg-black bg-opacity-30 border border-white border-opacity-20 font-mono text-sm"
                                placeholder="Paste your .kuro file content here..."
                        ></textarea>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label
                                    class="block text-sm font-medium mb-2"
                            >Mock Name (optional)</label
                            >
                            <input
                                    v-model="importMetadata.name"
                                    class="w-full p-3 rounded-lg bg-black bg-opacity-30 border border-white border-opacity-20"
                                    placeholder="Override mock name"
                            />
                        </div>
                        <div>
                            <label
                                    class="block text-sm font-medium mb-2"
                            >Description (optional)</label
                            >
                            <input
                                    v-model="importMetadata.description"
                                    class="w-full p-3 rounded-lg bg-black bg-opacity-30 border border-white border-opacity-20"
                                    placeholder="Override description"
                            />
                        </div>
                    </div>
                </div>

                <div class="flex gap-3 mt-6">
                    <button
                            @click="processImport"
                            :disabled="!importContent || isLoading"
                            :class="isLoading ? 'loading' : ''"
                            class="btn btn-primary flex-1"
                    >
                        {{ isLoading ? 'Importing...' : 'Import Mock' }}
                    </button>
                    <button
                            @click="showImportModal = false"
                            :disabled="isLoading"
                            class="btn"
                    >
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Workspace Manager Modal -->
    <div
            v-if="showWorkspaceModal"
            class="modal"
            @click="showWorkspaceModal = false"
    >
        <div class="modal-content p-6 w-full max-w-3xl" @click.stop>
            <h3 class="text-xl font-semibold mb-4">
                🏢 Workspace Manager
            </h3>

            <!-- Current Workspace -->
            <div class="mb-6 p-4 glass rounded-xl">
                <h4 class="text-lg font-medium mb-2">
                    Current Workspace
                </h4>
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                                <span class="text-lg"
                                >{{ currentUser === 'default' ? 'Default Workspace' : `Workspace ${currentUser}`}}</span
                                >
                        <span
                                v-if="workspaceLoading"
                                class="text-sm text-yellow-400"
                        >Loading...</span
                        >
                    </div>
                    <div class="flex items-center gap-2">
                                <span class="text-sm text-muted"
                                >{{ currentUser === 'default' ?
                                    '(Protected)' : '(User)' }}</span
                                >
                        <span
                                v-if="userMocks.length > 0"
                                class="px-2 py-1 bg-green-500/20 text-green-400 text-xs rounded"
                        >
                                    {{ userMocks.length }} mock{{
                                    userMocks.length === 1 ? '' : 's' }}
                                </span>
                    </div>
                </div>
            </div>

            <!-- Create New Workspace -->
            <div class="mb-6 p-4 glass rounded-xl">
                <h4 class="text-lg font-medium mb-3">
                    Create New Workspace
                </h4>
                <div class="flex gap-3">
                    <input
                            v-model="newWorkspaceName"
                            placeholder="Enter workspace name"
                            class="flex-1 p-3 rounded-lg bg-black bg-opacity-30 border border-white border-opacity-20"
                            @keyup.enter="createWorkspace"
                    />
                    <button
                            @click="createWorkspace"
                            :disabled="!newWorkspaceName.trim() || isLoading"
                            class="btn btn-success"
                    >
                        Create
                    </button>
                </div>
            </div>

            <!-- Workspace List -->
            <div class="mb-6">
                <h4 class="text-lg font-medium mb-3">
                    Available Workspaces
                </h4>
                <div class="space-y-3">
                    <div
                            v-for="workspace in workspaces"
                            :key="workspace.id"
                            class="flex items-center justify-between p-4 glass rounded-xl"
                            :class="workspace.id === currentUser ? 'border border-blue-500/50' : ''"
                    >
                        <div class="flex-1">
                            <div class="flex items-center gap-3">
                                <h5 class="font-medium">
                                    {{ workspace.name }}
                                </h5>
                                <span
                                        v-if="workspace.protected"
                                        class="px-2 py-1 bg-yellow-500/20 text-yellow-400 text-xs rounded"
                                >
                                            Protected
                                        </span>
                                <span
                                        v-if="workspace.id === currentUser"
                                        class="px-2 py-1 bg-blue-500/20 text-blue-400 text-xs rounded"
                                >
                                            Current
                                        </span>
                            </div>
                            <p class="text-sm text-muted mt-1">
                                {{ workspace.description }}
                            </p>
                            <p class="text-xs text-muted mt-1">
                                Created: {{
                                formatDate(workspace.created_at) }}
                            </p>
                        </div>
                        <div class="flex items-center gap-2">
                            <button
                                    v-if="workspace.id !== currentUser"
                                    @click="switchWorkspace(workspace.id)"
                                    class="btn btn-sm btn-primary"
                            >
                                Switch
                            </button>
                            <button
                                    v-if="!workspace.protected && workspace.id !== 'default'"
                                    @click="deleteWorkspace(workspace)"
                                    class="btn btn-sm btn-danger"
                            >
                                Delete
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex gap-3">
                <button
                        @click="showWorkspaceModal = false"
                        class="btn flex-1"
                >
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    const {
        createApp,
        ref,
        computed,
        onMounted,
        onUnmounted,
        nextTick,
    } = Vue;

    createApp({
        setup() {
            // ---- State ----
            const serverRunning = ref(false);
            const mocks = ref([]);
            const requestLogs = ref([]);
            const showEditModal = ref(false);
            const editingMock = ref({});
            const activeTab = ref("mocks");
            const isLoading = ref(false);
            const selectedConfigMock = ref(null);
            const configContent = ref("");
            const originalConfigContent = ref("");
            const configValidation = ref(null);
            const serverStartTime = ref(new Date());
            const savedServerState = ref(null);
            const toasts = ref([]);
            const portValidation = ref({
                error: false,
                message: "",
                conflicts: [],
            });

            // New reactive variables for enhanced features
            const publicConfig = ref(null);
            const userMocks = ref([]);
            const exampleMocks = ref([]);
            const userStats = ref(null);
            const currentUser = ref("default");
            const showUserMockModal = ref(false);
            const editingUserMock = ref({});
            const showImportModal = ref(false);
            const importContent = ref("");
            const importMetadata = ref({});

            // Workspace management
            const showWorkspaceModal = ref(false);
            const workspaces = ref([]);
            const newWorkspaceName = ref("");
            const currentWorkspace = ref("default");
            const workspaceLoading = ref(false);

            let refreshIntervalId = null;

            // ---- Helpers (before return) ----
            const getPortConflicts = (mock) =>
                mocks.value
                    .filter(
                        (m) =>
                            m.Running &&
                            m.Port === mock.Port &&
                            m.id !== mock.id,
                    )
                    .map((m) => m.Name);

            const validatePort = () => {
                const port = editingMock.value.Port;
                const conflicts = getPortConflicts(
                    editingMock.value || {},
                );
                if (!port || port < 1 || port > 65535) {
                    portValidation.value = {
                        error: true,
                        message: "Port must be between 1 and 65535",
                        conflicts: [],
                    };
                } else if (conflicts.length > 0) {
                    portValidation.value = {
                        error: false,
                        message: "",
                        conflicts,
                    };
                } else {
                    portValidation.value = {
                        error: false,
                        message: "",
                        conflicts: [],
                    };
                }
            };

            const showToast = (
                type,
                title,
                message,
                duration = 5000,
            ) => {
                const id = Date.now() + Math.random();
                const icon =
                    {
                        success: "check-circle",
                        error: "alert-circle",
                        warning: "alert-triangle",
                    }[type] || "info";
                toasts.value.push({id, type, title, message, icon});
                setTimeout(() => removeToast(id), duration);
            };
            const removeToast = (id) => {
                toasts.value = toasts.value.filter((t) => t.id !== id);
            };

            const importKuroFile = async (event) => {
                const file = event?.target?.files?.[0];
                if (!file) return;
                try {
                    const text = await file.text();
                    const lines = text.split("\n");
                    const config = {};
                    lines.forEach((line) => {
                        const trimmed = line.trim();
                        if (
                            trimmed.includes(":") &&
                            !trimmed.startsWith(" ") &&
                            !trimmed.startsWith("-")
                        ) {
                            const [key, ...rest] = trimmed.split(":");
                            const value = rest.join(":").trim();
                            if (value) {
                                if (key === "protocol")
                                    config.protocol = value.replace(
                                        /['"]/g,
                                        "",
                                    );
                                else if (key === "port")
                                    config.port = parseInt(value, 10);
                            }
                        }
                    });
                    const mockData = {
                        name: file.name.replace(
                            /\.(kuro|yaml|yml)$/i,
                            "",
                        ),
                        protocol: config.protocol || "http",
                        port: Number.isFinite(config.port)
                            ? config.port
                            : 8080,
                        description: `Imported from ${file.name}`,
                    };
                    const res = await fetch("/api/mocks", {
                        method: "POST",
                        headers: {"Content-Type": "application/json"},
                        body: JSON.stringify(mockData),
                    });
                    if (!res.ok) throw new Error(await res.text());
                    showToast(
                        "success",
                        "Imported",
                        `Successfully imported ${file.name}`,
                    );
                    await refresh();
                } catch (error) {
                    console.error(error);
                    showToast(
                        "error",
                        "Import Failed",
                        String(error.message || error),
                    );
                } finally {
                    if (event?.target) event.target.value = "";
                }
            };

            // ---- API ----
            const API = {
                getMocks: () =>
                    fetch("/api/mocks").then((r) => r.json()),
                toggleMock: (id) =>
                    fetch(`/api/mocks/${id}/toggle`, {
                        method: "POST",
                    }),
                serverToggle: (action) =>
                    fetch("/api/server/toggle", {
                        method: "POST",
                        headers: {"Content-Type": "application/json"},
                        body: JSON.stringify({action}),
                    }),
                addMock: (mock) =>
                    fetch("/api/mocks", {
                        method: "POST",
                        headers: {"Content-Type": "application/json"},
                        body: JSON.stringify(mock),
                    }),
                updateMock: (id, mock) =>
                    fetch(`/api/mocks/${id}`, {
                        method: "PUT",
                        headers: {"Content-Type": "application/json"},
                        body: JSON.stringify(mock),
                    }),

                // User workspace APIs
                getPublicConfig: () => fetch("/api/config"),
                getUserMocks: (userID) =>
                    fetch(`/api/user/${userID}/mocks`),
                createUserMock: (userID, mock) =>
                    fetch(`/api/user/${userID}/mocks`, {
                        method: "POST",
                        headers: {"Content-Type": "application/json"},
                        body: JSON.stringify(mock),
                    }),
                updateUserMock: (userID, mockID, updates) =>
                    fetch(`/api/user/${userID}/mocks/${mockID}`, {
                        method: "PUT",
                        headers: {"Content-Type": "application/json"},
                        body: JSON.stringify(updates),
                    }),
                deleteUserMock: (userID, mockID) =>
                    fetch(`/api/user/${userID}/mocks/${mockID}`, {
                        method: "DELETE",
                    }),
                exportUserMock: (userID, mockID) =>
                    fetch(`/api/user/${userID}/mocks/${mockID}/export`),
                importUserMock: (userID, content, metadata) =>
                    fetch(`/api/user/${userID}/import`, {
                        method: "POST",
                        headers: {"Content-Type": "application/json"},
                        body: JSON.stringify({content, metadata}),
                    }),
                getUserStats: (userID) =>
                    fetch(`/api/user/${userID}/stats`),

                // Workspace management APIs
                getWorkspaces: () => fetch("/api/workspaces"),
                createWorkspace: (userID) =>
                    fetch(`/api/user/${userID}/workspace`, {
                        method: "POST",
                    }),
                deleteWorkspace: (userID) =>
                    fetch(`/api/user/${userID}/workspace`, {
                        method: "DELETE",
                    }),
                switchWorkspace: (userID) => {
                    // This is handled locally by changing currentUser
                    return Promise.resolve();
                },
            };

            // ---- Computed ----
            const sortedMocks = computed(() => {
                const order = {
                    http: 0,
                    https: 1,
                    tcp: 2,
                    websocket: 3,
                    sftp: 4,
                };
                return [...mocks.value].sort((a, b) => {
                    const aO =
                        order[(a.Protocol || "").toLowerCase()] ?? 99;
                    const bO =
                        order[(b.Protocol || "").toLowerCase()] ?? 99;
                    if (aO !== bO) return aO - bO;
                    return (a.Name || "").localeCompare(b.Name || "");
                });
            });

            const runningMocks = computed(
                () => mocks.value.filter((m) => m.Running).length,
            );

            const serverUptime = computed(() => {
                if (!serverRunning.value) return "0m";
                const diff = Math.floor(
                    (Date.now() - serverStartTime.value.getTime()) /
                    1000,
                );
                if (diff < 60) return `${diff}s`;
                if (diff < 3600) return `${Math.floor(diff / 60)}m`;
                return `${Math.floor(diff / 3600)}h ${Math.floor((diff % 3600) / 60)}m`;
            });

            // ---- Actions ----
            const addLog = (type, method, message, status = null) => {
                requestLogs.value.unshift({
                    time: new Date().toLocaleTimeString(),
                    type,
                    method,
                    message,
                    status,
                });
                if (requestLogs.value.length > 100)
                    requestLogs.value = requestLogs.value.slice(0, 100);
            };

            const refresh = async () => {
                if (isLoading.value) return;
                isLoading.value = true;
                try {
                    const data = await API.getMocks();
                    const wasRunning = serverRunning.value;
                    serverRunning.value = data.serverStatus || false;
                    if (!wasRunning && serverRunning.value)
                        serverStartTime.value = new Date();
                    mocks.value = (data.mocks || []).map((m) => ({
                        id: m.id,
                        Name: m.name,
                        Protocol: m.protocol,
                        Port: m.port,
                        Description: m.description,
                        Running: m.running,
                        LastStarted: m.lastStarted
                            ? new Date(m.lastStarted)
                            : null,
                    }));
                } catch (e) {
                    addLog(
                        "ERROR",
                        "SYSTEM",
                        "Failed to refresh mocks",
                        500,
                    );
                    console.error(e);
                } finally {
                    isLoading.value = false;
                    await nextTick();
                    if (window.lucide?.createIcons)
                        lucide.createIcons();
                }
            };

            const toggleMock = async (id) => {
                const mock = mocks.value.find((m) => m.id === id);
                if (!mock) return;
                if (!mock.Running) {
                    const conflicts = getPortConflicts(mock);
                    if (conflicts.length) {
                        showToast(
                            "error",
                            "Port Conflict",
                            `Cannot start "${mock.Name}". Port ${mock.Port} is used by: ${conflicts.join(", ")}`,
                        );
                        return;
                    }
                }
                try {
                    const res = await API.toggleMock(id);
                    if (!res.ok) throw new Error(await res.text());
                    addLog(
                        "INFO",
                        (mock.Protocol || "").toUpperCase(),
                        `Mock "${mock.Name}" ${mock.Running ? "stopped" : "started"}`,
                        200,
                    );
                    showToast(
                        "success",
                        "Success",
                        `Mock "${mock.Name}" ${mock.Running ? "stopped" : "started"} successfully`,
                    );
                    await refresh();
                } catch (e) {
                    let msg = e.message || "Unknown error";
                    if (msg.includes("already in use"))
                        msg = `Port ${mock.Port} is already in use.`;
                    addLog(
                        "ERROR",
                        (mock.Protocol || "").toUpperCase(),
                        `Failed to toggle mock "${mock.Name}"`,
                        500,
                    );
                    showToast("error", "Failed to Toggle Mock", msg);
                }
            };

            const toggleServer = async () => {
                const action = serverRunning.value ? "stop" : "start";
                try {
                    await API.serverToggle(action);
                    addLog("INFO", "SYSTEM", `Server ${action}ed`, 200);
                    await refresh();
                } catch (e) {
                    addLog(
                        "ERROR",
                        "SYSTEM",
                        `Failed to ${action} server`,
                        500,
                    );
                }
            };

            const createNewMock = () => {
                editingMock.value = {
                    Name: "New Mock Service",
                    Protocol: "http",
                    Port: 8080,
                    Description: "",
                };
                portValidation.value = {
                    error: false,
                    message: "",
                    conflicts: [],
                };
                showEditModal.value = true;
            };

            const editMock = (mock) => {
                editingMock.value = {...mock};
                portValidation.value = {
                    error: false,
                    message: "",
                    conflicts: [],
                };
                showEditModal.value = true;
            };

            const saveMock = async () => {
                if (portValidation.value.error) {
                    showToast(
                        "error",
                        "Validation Error",
                        portValidation.value.message,
                    );
                    return;
                }
                isLoading.value = true;
                try {
                    const payload = {
                        name: editingMock.value.Name,
                        protocol: editingMock.value.Protocol,
                        port: editingMock.value.Port,
                        description: editingMock.value.Description,
                    };
                    const res = editingMock.value.id
                        ? await API.updateMock(
                            editingMock.value.id,
                            payload,
                        )
                        : await API.addMock(payload);
                    if (!res.ok) throw new Error(await res.text());
                    addLog(
                        "INFO",
                        "SYSTEM",
                        `Mock "${editingMock.value.Name}" ${editingMock.value.id ? "updated" : "created"}`,
                        editingMock.value.id ? 200 : 201,
                    );
                    showToast(
                        "success",
                        "Success",
                        `Mock "${editingMock.value.Name}" ${editingMock.value.id ? "updated" : "created"} successfully`,
                    );
                    closeEditModal();
                    await refresh();
                } catch (e) {
                    addLog(
                        "ERROR",
                        "SYSTEM",
                        `Failed to save mock: ${e.message}`,
                        500,
                    );
                    showToast(
                        "error",
                        "Save Failed",
                        `Failed to save mock: ${e.message}`,
                    );
                } finally {
                    isLoading.value = false;
                }
            };

            const closeEditModal = () => {
                showEditModal.value = false;
                editingMock.value = {};
                portValidation.value = {
                    error: false,
                    message: "",
                    conflicts: [],
                };
            };

            // User workspace
            const refreshPublicConfig = async () => {
                try {
                    const res = await API.getPublicConfig();
                    if (res.ok) publicConfig.value = await res.json();
                } catch (e) {
                    console.error("Failed to load public config:", e);
                }
            };

            const refreshUserMocks = async () => {
                try {
                    workspaceLoading.value = true;
                    const res = await API.getUserMocks(
                        currentUser.value,
                    );
                    if (res.ok) {
                        const data = await res.json();
                        userMocks.value = data.mocks || [];
                        exampleMocks.value = data.example_mocks || [];
                        currentWorkspace.value =
                            data.current_workspace || currentUser.value;
                    } else {
                        throw new Error(await res.text());
                    }
                } catch (e) {
                    console.error("Failed to load user mocks:", e);
                    showToast(
                        "error",
                        "Load Failed",
                        "Failed to load workspace mocks",
                    );
                } finally {
                    workspaceLoading.value = false;
                }
            };

            const refreshUserStats = async () => {
                try {
                    const res = await API.getUserStats(
                        currentUser.value,
                    );
                    if (res.ok) userStats.value = await res.json();
                } catch (e) {
                    console.error("Failed to load user stats:", e);
                }
            };

            const createUserMock = () => {
                // Auto-suggest next available port
                const usedPorts = [
                    ...userMocks.value,
                    ...exampleMocks.value,
                ].map((m) => m.port);
                let suggestedPort = 8080;
                while (usedPorts.includes(suggestedPort)) {
                    suggestedPort++;
                }

                editingUserMock.value = {
                    name: "New User Mock",
                    protocol: "http",
                    port: suggestedPort,
                    description: `Custom mock for ${currentUser.value} workspace`,
                    content: `protocol: http
port: ${suggestedPort}
meta:
  name: "New User Mock"
  description: "Auto-generated mock configuration"

routes:
  - path: /
    method: GET
    response:
      status: 200
      headers:
        Content-Type: application/json
      body: |
        {
          "message": "Hello from ${currentUser.value} workspace!",
          "timestamp": "{{ now }}",
          "workspace": "${currentUser.value}"
        }`,
                };
                showUserMockModal.value = true;
            };

            const editUserMock = (mock) => {
                editingUserMock.value = {...mock};
                showUserMockModal.value = true;
            };

            const saveUserMock = async () => {
                try {
                    isLoading.value = true;
                    const res = editingUserMock.value.id
                        ? await API.updateUserMock(
                            currentUser.value,
                            editingUserMock.value.id,
                            editingUserMock.value,
                        )
                        : await API.createUserMock(
                            currentUser.value,
                            editingUserMock.value,
                        );
                    if (!res.ok) throw new Error(await res.text());
                    showToast(
                        "success",
                        "Mock Saved",
                        "User mock saved successfully to workspace",
                    );
                    showUserMockModal.value = false;
                    await refreshUserMocks();
                    await refreshUserStats();
                } catch (e) {
                    showToast("error", "Save Failed", e.message);
                } finally {
                    isLoading.value = false;
                }
            };

            const deleteUserMock = async (mock) => {
                if (!confirm(`Delete mock "${mock.name}"?`)) return;
                try {
                    const res = await API.deleteUserMock(
                        currentUser.value,
                        mock.id,
                    );
                    if (!res.ok) throw new Error(await res.text());
                    showToast(
                        "success",
                        "Mock Deleted",
                        "User mock deleted from workspace",
                    );
                    await refreshUserMocks();
                    await refreshUserStats();
                } catch (e) {
                    showToast("error", "Delete Failed", e.message);
                }
            };

            const exportUserMock = async (mock) => {
                try {
                    const res = await API.exportUserMock(
                        currentUser.value,
                        mock.id,
                    );
                    if (!res.ok) throw new Error(await res.text());
                    const blob = await res.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = `${mock.name}.kuro`;
                    a.click();
                    window.URL.revokeObjectURL(url);
                    showToast(
                        "success",
                        "Export Complete",
                        "Mock exported successfully",
                    );
                } catch (e) {
                    showToast("error", "Export Failed", e.message);
                }
            };

            const importUserMock = () => {
                importContent.value = "";
                importMetadata.value = {};
                showImportModal.value = true;
            };

            // Workspace management functions
            const refreshWorkspaces = async () => {
                try {
                    const res = await API.getWorkspaces();
                    if (!res.ok) throw new Error(await res.text());
                    const data = await res.json();
                    workspaces.value = data.workspaces || [];
                } catch (e) {
                    showToast("error", "Load Failed", e.message);
                }
            };

            const openWorkspaceManager = () => {
                refreshWorkspaces();
                showWorkspaceModal.value = true;
            };

            const createWorkspace = async () => {
                if (!newWorkspaceName.value.trim()) {
                    showToast(
                        "warning",
                        "Invalid Input",
                        "Please enter a workspace name",
                    );
                    return;
                }
                try {
                    const res = await API.createWorkspace(
                        newWorkspaceName.value.trim(),
                    );
                    if (!res.ok) throw new Error(await res.text());
                    showToast(
                        "success",
                        "Workspace Created",
                        "New workspace created successfully",
                    );
                    newWorkspaceName.value = "";
                    await refreshWorkspaces();
                } catch (e) {
                    showToast("error", "Create Failed", e.message);
                }
            };

            const switchWorkspace = async (workspaceId) => {
                try {
                    workspaceLoading.value = true;
                    const oldWorkspace = currentUser.value;
                    currentUser.value = workspaceId;
                    currentWorkspace.value = workspaceId;

                    await refreshUserMocks();
                    await refreshUserStats();

                    showWorkspaceModal.value = false;
                    showToast(
                        "success",
                        "Workspace Switched",
                        `Switched from '${oldWorkspace}' to '${workspaceId}' workspace`,
                    );
                } catch (e) {
                    showToast("error", "Switch Failed", e.message);
                } finally {
                    workspaceLoading.value = false;
                }
            };

            const deleteWorkspace = async (workspace) => {
                if (workspace.protected) {
                    showToast(
                        "warning",
                        "Cannot Delete",
                        "Protected workspaces cannot be deleted",
                    );
                    return;
                }

                const userMockCount = userMocks.value.length;
                const confirmMessage = `Delete workspace "${workspace.name}"?\n\nThis will remove:\n• ${userMockCount} user mock(s) in this workspace\n• Workspace configuration and data\n• All custom files and uploads\n\nExample mocks will be preserved and remain available.\n\nThis action cannot be undone.`;

                if (!confirm(confirmMessage)) return;

                try {
                    workspaceLoading.value = true;
                    const res = await API.deleteWorkspace(workspace.id);
                    if (!res.ok) {
                        const errorText = await res.text();
                        throw new Error(errorText);
                    }

                    const result = await res.json();
                    showToast(
                        "success",
                        "Workspace Deleted",
                        `Workspace '${workspace.name}' deleted successfully. ${result.deleted_mocks || 0} mocks removed. Example mocks preserved.`,
                    );

                    // If we deleted the current workspace, switch to default
                    if (currentUser.value === workspace.id) {
                        await switchWorkspace("default");
                    }
                    await refreshWorkspaces();
                } catch (e) {
                    showToast("error", "Delete Failed", e.message);
                } finally {
                    workspaceLoading.value = false;
                }
            };

            const processImport = async () => {
                try {
                    isLoading.value = true;
                    const res = await API.importUserMock(
                        currentUser.value,
                        importContent.value,
                        importMetadata.value,
                    );
                    if (!res.ok) throw new Error(await res.text());
                    showToast(
                        "success",
                        "Import Complete",
                        "Mock imported successfully to workspace",
                    );
                    showImportModal.value = false;
                    await refreshUserMocks();
                    await refreshUserStats();
                } catch (e) {
                    showToast("error", "Import Failed", e.message);
                } finally {
                    isLoading.value = false;
                }
            };

            const formatDate = (dateString) => {
                try {
                    return new Date(dateString).toLocaleDateString();
                } catch {
                    return "Unknown";
                }
            };

            const editMockConfig = (mock) => {
                selectedConfigMock.value = mock;
                activeTab.value = "config";
                loadMockConfig(mock);
            };

            const loadMockConfig = (mock) => {
                const config = `protocol: ${mock.Protocol}
port: ${mock.Port}
meta:
  name: "${mock.Name}"
  description: "${mock.Description || "Mock service configuration"}"

context:
  variables:
    version: "1.0.0"
    environment: "development"

routes:
  - path: /health
    method: GET
    response:
      status: 200
      headers:
        Content-Type: application/json
      body: |
        {
          "status": "healthy",
          "timestamp": "{{ now }}",
          "service": "${mock.Name}"
        }

  - path: /api/data
    method: GET
    response:
      status: 200
      headers:
        Content-Type: application/json
      body: |
        {
          "data": [],
          "total": 0,
          "timestamp": "{{ now }}"
        }

  - path: /api/data
    method: POST
    response:
      status: 201
      headers:
        Content-Type: application/json
      body: |
        {
          "id": "{{ uuid }}",
          "message": "Created successfully",
          "timestamp": "{{ now }}"
        }`;
                configContent.value = config;
                originalConfigContent.value = config;
            };

            const saveConfig = async () => {
                try {
                    validateConfig();
                    if (configValidation.value?.valid) {
                        originalConfigContent.value =
                            configContent.value;
                        addLog(
                            "INFO",
                            "CONFIG",
                            `Configuration saved for "${selectedConfigMock.value.Name}"`,
                            200,
                        );
                        showToast(
                            "success",
                            "Config Saved",
                            "Configuration stored successfully",
                        );
                    }
                } catch (e) {
                    addLog(
                        "ERROR",
                        "CONFIG",
                        `Failed to save configuration: ${e.message}`,
                        500,
                    );
                }
            };

            const resetConfig = () => {
                configContent.value = originalConfigContent.value;
                configValidation.value = null;
            };

            const validateConfig = () => {
                try {
                    const lines = configContent.value.split("\n");
                    const hasProtocol = lines.some((l) =>
                        l.trim().startsWith("protocol:"),
                    );
                    const hasPort = lines.some((l) =>
                        l.trim().startsWith("port:"),
                    );
                    configValidation.value =
                        hasProtocol && hasPort
                            ? {valid: true, errors: null}
                            : {
                                valid: false,
                                errors: "Configuration must include protocol and port fields",
                            };
                } catch (e) {
                    configValidation.value = {
                        valid: false,
                        errors: e.message,
                    };
                }
            };

            const addEndpoint = () => {
                const endpoint = `
  - path: /api/new-endpoint
    method: GET
    response:
      status: 200
      headers:
        Content-Type: application/json
      body: |
        {
          "message": "New endpoint response",
          "timestamp": "{{ now }}"
        }`;
                const lines = configContent.value.split("\n");
                const idx = lines.findIndex((l) =>
                    l.includes("routes:"),
                );
                if (idx !== -1) {
                    lines.splice(idx + 1, 0, ...endpoint.split("\n"));
                    configContent.value = lines.join("\n");
                }
            };

            const addVariable = () => {
                const lines = configContent.value.split("\n");
                const idx = lines.findIndex((l) =>
                    l.includes("variables:"),
                );
                if (idx !== -1) {
                    lines.splice(
                        idx + 1,
                        0,
                        `    newVariable: "value"`,
                    );
                    configContent.value = lines.join("\n");
                }
            };

            const addResponse = () => {
                configContent.value += `\n      body: |
        {
          "custom": "response",
          "timestamp": "{{ now }}"
        }`;
            };

            const saveServerState = () => {
                const state = {
                    timestamp: new Date().toISOString(),
                    serverRunning: serverRunning.value,
                    mockStates: mocks.value.map((m) => ({
                        id: m.id,
                        name: m.Name,
                        running: m.Running,
                    })),
                };
                savedServerState.value = state;
                localStorage.setItem(
                    "useKuroServerState",
                    JSON.stringify(state),
                );
                addLog("INFO", "SYSTEM", "Server state saved", 200);
            };

            const restoreServerState = async () => {
                const saved =
                    localStorage.getItem("useKuroServerState");
                if (!saved) {
                    addLog(
                        "WARN",
                        "SYSTEM",
                        "No saved state found",
                        404,
                    );
                    return;
                }
                try {
                    const state = JSON.parse(saved);
                    if (state.serverRunning && !serverRunning.value)
                        await toggleServer();
                    for (const s of state.mockStates) {
                        const cur = mocks.value.find(
                            (m) => m.id === s.id,
                        );
                        if (cur && cur.Running !== s.running) {
                            await toggleMock(s.id);
                            await new Promise((r) =>
                                setTimeout(r, 500),
                            );
                        }
                    }
                    addLog(
                        "INFO",
                        "SYSTEM",
                        `Server state restored from ${new Date(state.timestamp).toLocaleString()}`,
                        200,
                    );
                } catch (e) {
                    addLog(
                        "ERROR",
                        "SYSTEM",
                        `Failed to restore state: ${e.message}`,
                        500,
                    );
                }
            };

            const clearLogs = () => {
                requestLogs.value = [];
            };

            const exportLogs = () => {
                const txt = requestLogs.value
                    .map(
                        (l) =>
                            `${l.time} [${l.type}] ${l.method} - ${l.message}${l.status ? ` (${l.status})` : ""}`,
                    )
                    .join("\n");
                const blob = new Blob([txt], {type: "text/plain"}),
                    url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `usekuro-logs-${new Date().toISOString().split("T")[0]}.txt`;
                a.click();
                URL.revokeObjectURL(url);
            };

            const getProtocolClass = (protocol) => {
                const p = (protocol || "").toLowerCase();
                if (p === "http" || p === "https")
                    return "protocol-http";
                if (p === "sftp" || p === "ftp") return "protocol-sftp";
                if (p === "tcp") return "protocol-tcp";
                if (p === "websocket" || p === "ws")
                    return "protocol-websocket";
                return "protocol-http";
            };

            const formatTime = (date) => {
                const diff = Math.floor(
                    (Date.now() - date.getTime()) / 1000,
                );
                if (diff < 60) return `${diff}s ago`;
                if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
                if (diff < 86400)
                    return `${Math.floor(diff / 3600)}h ago`;
                return `${Math.floor(diff / 86400)}d ago`;
            };

            const getLogTypeClass = (type) => {
                if (type === "ERROR")
                    return "bg-red-500/20 text-red-400";
                if (type === "WARN")
                    return "bg-yellow-500/20 text-yellow-400";
                if (type === "INFO")
                    return "bg-blue-500/20 text-blue-400";
                return "bg-gray-500/20 text-gray-400";
            };

            const getStatusClass = (status) => {
                if (status >= 200 && status < 300)
                    return "bg-green-500/20 text-green-400";
                if (status >= 300 && status < 400)
                    return "bg-blue-500/20 text-blue-400";
                if (status >= 400 && status < 500)
                    return "bg-yellow-500/20 text-yellow-400";
                if (status >= 500) return "bg-red-500/20 text-red-400";
                return "bg-gray-500/20 text-gray-400";
            };

            // ---- Lifecycle ----
            onMounted(async () => {
                await refresh();
                await refreshPublicConfig();
                await refreshUserMocks();
                await refreshUserStats();
                refreshIntervalId = setInterval(refresh, 10000);
                const saved =
                    localStorage.getItem("useKuroServerState");
                if (saved) {
                    try {
                        savedServerState.value = JSON.parse(saved);
                    } catch (e) {
                        console.warn("Failed to load saved state:", e);
                    }
                }
                await nextTick();
                if (window.lucide?.createIcons) lucide.createIcons();
            });

            onUnmounted(() => {
                if (refreshIntervalId) clearInterval(refreshIntervalId);
            });

            // ---- expose to template ----
            return {
                // state
                serverRunning,
                mocks,
                publicConfig,
                userMocks,
                exampleMocks,
                userStats,
                currentUser,
                showUserMockModal,
                editingUserMock,
                showImportModal,
                requestLogs,
                showEditModal,
                editingMock,
                activeTab,
                isLoading,
                selectedConfigMock,
                configContent,
                originalConfigContent,
                configValidation,
                serverStartTime,
                toasts,
                portValidation,
                // computed
                sortedMocks,
                runningMocks,
                serverUptime,
                // actions
                refresh,
                toggleMock,
                toggleServer,
                createNewMock,
                editMock,
                saveMock,
                closeEditModal,
                editMockConfig,
                saveConfig,
                resetConfig,
                validateConfig,
                addEndpoint,
                addVariable,
                addResponse,
                saveServerState,
                restoreServerState,
                importKuroFile,
                clearLogs,
                exportLogs,
                // helpers
                getProtocolClass,
                formatTime,
                getLogTypeClass,
                getStatusClass,
                validatePort,
                getPortConflicts,
                showToast,
                removeToast,
                // workspace
                refreshPublicConfig,
                refreshUserMocks,
                refreshUserStats,
                createUserMock,
                editUserMock,
                saveUserMock,
                deleteUserMock,
                exportUserMock,
                importUserMock,
                processImport,
                formatDate,
                importContent,
                importMetadata,

                // workspace management
                refreshWorkspaces,
                openWorkspaceManager,
                createWorkspace,
                switchWorkspace,
                deleteWorkspace,
                showWorkspaceModal,
                workspaces,
                newWorkspaceName,
                currentWorkspace,
                workspaceLoading,
            };
        },
    }).mount("#app");
</script>
</body>
</html>
